# -----------------------------
# Git Prompt
# -----------------------------
source ~/.git-prompt.sh

# Git status indicators
GIT_PS1_SHOWDIRTYSTATE=1
GIT_PS1_SHOWSTASHSTATE=1
GIT_PS1_SHOWUNTRACKEDFILES=1
GIT_PS1_SHOWUPSTREAM="auto"
GIT_PS1_STATESEPARATOR="|"
GIT_PS1_SHOWCOLORHINTS=yes
GIT_PS1_SHOWCONFLICTSTATE=yes
GIT_PS1_HIDE_IF_PWD_IGNORED=yes

# PS1 prompt with git branch
PROMPT_COMMAND='PS1="\[\033[1;32m\]\u\[\033[00m\]:\[\033[1;34m\]\w\[\033[1;31m\]$(__git_ps1)\[\033[00m\] \$ "'

# -----------------------------
# Tools
# -----------------------------

# mise
eval "$(~/.local/bin/mise activate bash)"

## tmux
# tmux session selector function
function ts() {
  if [[ -n $TMUX ]]; then
    echo "Already in a tmux session"
    return 1
  fi

  local ID create_new_session
  ID="$(tmux list-sessions 2>/dev/null)"
  if [[ -z "$ID" ]]; then
    tmux new-session
    return
  fi
  create_new_session="Create New Session"
  ID="$ID\n${create_new_session}:"
  ID="$(echo $ID | fzf | cut -d: -f1)"
  if [[ "$ID" = "${create_new_session}" ]]; then
    tmux new-session
  elif [[ -n "$ID" ]]; then
    tmux attach-session -t "$ID"
  fi
}

# Auto start tmux
if [[ ! -n $TMUX ]] && [[ "$TMUX_AUTO_START" == "true" ]]; then
  ts
fi

# -----------------------------
# Alias
# -----------------------------

alias ll='ls -la'
alias less='less -R'
alias sz='source ~/.bashrc'
alias pre='pre-commit run -a'
alias cl='claude'
alias cx='codex'
alias difit='npx -y difit@latest'
alias dif='difit .'
alias cz='chezmoi'
alias czc='chezmoi cd'
alias cze='chezmoi edit'
alias cza='chezmoi apply && sz'

## git
alias gst='git status'
alias gfp='git fetch -p && git-delete-merged-branches'
alias gpp='git pull -p && git-delete-merged-branches'
alias gco='git branch -a | fzf | xargs git checkout'
alias gsw='git branch -a | fzf | sed "s@remotes/origin/@@g" | xargs git switch'

alias lg='lazygit'
alias ws='cd $WS/$(ls $WS | fzf)'

# -----------------------------
# Function
# -----------------------------

function cd_target(){
  d=$( \
    fd --type d -H \
    -E .git \
    -E node_modules \
    -E .terragrunt-cache \
    | fzf )

  if [[ $d = "" ]]; then
    return
  fi

  cd $d
}

bind -x '"\C-k": cd_target'

# 最寄りの.gitがあるディレクトリをrootとする
function cdr() {
  export TMP_CDR_DIR=$(pwd)

  while [[ $TMP_CDR_DIR != "/" ]]
  do
    if [ -e "$TMP_CDR_DIR/.git" ];then
      echo $TMP_CDR_DIR
      cd $TMP_CDR_DIR
      break
    else
      export TMP_CDR_DIR=$( dirname $TMP_CDR_DIR )
    fi
  done
  unset TMP_CDR_DIR
}

### git
function dev() {
  switch_pull develop
}

function main() {
  if git rev-parse --verify main >/dev/null 2>&1; then
    switch_pull main
  elif git rev-parse --verify master >/dev/null 2>&1; then
    switch_pull master
  else
    echo "Neither main nor master branch exists"
  fi
}

function switch_pull() {
  git switch $1
  gpp
}

# Git worktree add - fzfでブランチを選択してworktreeを追加
function gwa() {
  local branch_name

  if [ $# -eq 0 ]; then
    branch_name=$(git branch -a | grep -v HEAD | sed 's/^\*\s*//' | sed 's/^\s*//' | sed 's/remotes\/origin\///' | sort -u | fzf --prompt="Select branch for worktree> ")

    if [ -z "$branch_name" ]; then
      return 1
    fi
  else
    branch_name="$1"
  fi

  local repository=$(basename $(pwd))
  local dir_name=$(echo "$branch_name" | sed 's/\//_/g')
  local worktree_dir="$WORKTREE_DIR/$repository/$dir_name"
  mkdir -p "$WORKTREE_DIR/$repository"
  git worktree add "$worktree_dir" "$branch_name"

  if [ $? -eq 0 ]; then
    cd "$worktree_dir"
  fi
}

# Git worktree add -b - 新しいブランチを作成してworktreeを追加
function gwab() {
  if [ $# -eq 0 ]; then
    echo "Usage: gwab <branch-name>"
    return 1
  fi

  local branch_name="$1"
  local repository=$(basename $(pwd))
  local dir_name=$(echo "$branch_name" | sed 's/\//_/g')
  local worktree_dir="$WORKTREE_DIR/$repository/$dir_name"
  mkdir -p "$WORKTREE_DIR/$repository"
  git worktree add -b "$branch_name" "$worktree_dir"

  if [ $? -eq 0 ]; then
    cd "$worktree_dir"
  fi
}

# Git worktree remove - fzfで選択してworktreeを削除
function gwrm() {
  local selected_worktree
  selected_worktree=$(git worktree list | fzf --prompt="Remove worktree> ")

  if [ -n "$selected_worktree" ]; then
    local worktree_path=$(echo "$selected_worktree" | awk '{print $1}')
    echo "Removing worktree: $worktree_path"
    git worktree remove "$worktree_path" --force
  fi
}

# Git worktree cd - fzfで選択してworktreeにcd
function gwcd() {
  local selected_worktree
  selected_worktree=$(git worktree list | grep -v "(bare)" | fzf --prompt="Change to worktree> ")

  if [ -n "$selected_worktree" ]; then
    local worktree_path=$(echo "$selected_worktree" | awk '{print $1}')
    cd "$worktree_path"
  fi
}

# Git worktree list - worktreeの一覧を見やすく表示
function gwls() {
  echo "=== Git Worktrees ==="
  git worktree list
}

### fzf history
function fzf-select-history() {
  local selected
  selected=$(history | sed 's/^ *[0-9]* *//' | fzf --tac --query "$READLINE_LINE" --reverse)
  if [[ -n "$selected" ]]; then
    READLINE_LINE="$selected"
    READLINE_POINT=${#READLINE_LINE}
  fi
}
bind -x '"\C-r": fzf-select-history'

function bu() {
  chezmoi update && chezmoi apply
  mise self-update -y
  mise install

  npm install -g @openai/codex

  sz
}
